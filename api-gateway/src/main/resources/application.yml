server:
  port: 8585

spring:
  application:
    name: api-gateway
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
      - org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration
  cloud:
    gateway:
      # Enable discovery locator to create routes dynamically from Eureka
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # Route to malaka-external service - All external APIs (must be first for priority)
        - id: malaka-external
          uri: lb://malaka-external
          predicates:
            - Path=/api/external/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaExternalCircuitBreaker
                fallbackUri: forward:/fallback
        # Route to malaka-internal service - Authentication endpoints
        - id: malaka-internal-auth
          uri: lb://malaka-internal
          predicates:
            - Path=/api/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - User management
        - id: malaka-internal-user
          uri: lb://malaka-internal
          predicates:
            - Path=/api/user/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        - id: malaka-internal-group
          uri: lb://malaka-internal
          predicates:
            - Path=/api/group/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - Student Applications (for methodists)
        - id: malaka-internal-application
          uri: lb://malaka-internal
          predicates:
            - Path=/api/application/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback
        # Route to malaka-internal service - Courses list (plural)
        - id: malaka-internal-courses
          uri: lb://malaka-internal
          predicates:
            - Path=/api/courses/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - Course management (singular)
        - id: malaka-internal-course
          uri: lb://malaka-internal
          predicates:
            - Path=/api/course/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - Module management
        - id: malaka-internal-module
          uri: lb://malaka-internal
          predicates:
            - Path=/api/module/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - Topic management
        - id: malaka-internal-topic
          uri: lb://malaka-internal
          predicates:
            - Path=/api/topic/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - Test management
        - id: malaka-internal-test
          uri: lb://malaka-internal
          predicates:
            - Path=/api/test/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - File management
        - id: malaka-internal-file
          uri: lb://malaka-internal
          predicates:
            - Path=/api/file/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - Citizen information (E-Gov integration)
        - id: malaka-internal-info
          uri: lb://malaka-internal
          predicates:
            - Path=/api/info/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

        # Route to malaka-internal service - Reference data (spr)
        - id: malaka-internal-spr
          uri: lb://malaka-internal
          predicates:
            - Path=/api/spr/**
          filters:
            - name: CircuitBreaker
              args:
                name: malakaInternalCircuitBreaker
                fallbackUri: forward:/fallback

# Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${random.value}
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90